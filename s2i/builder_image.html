<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Builder Requirements - Zcloud Source to Image</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-brand">
              <image class="sidebar-icon" src="../images/icon.png" />
              <b class="sidebar-book-title">Zcloud Source to Image</b>
            </div>
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li><a href="../s2i.html"><strong aria-hidden="true">1.</strong> S2I Intro</a></li><li><ol class="section"><li><a href="../s2i/builder_image.html" class="active"><strong aria-hidden="true">1.1.</strong> Builder Requirements</a></li><li><a href="../s2i/cli.html"><strong aria-hidden="true">1.2.</strong> CLI</a></li><li><a href="../s2i/debugging-s2i.html"><strong aria-hidden="true">1.3.</strong> Debugging</a></li><li><a href="../s2i/new_labels.html"><strong aria-hidden="true">1.4.</strong> New Lables</a></li><li><a href="../s2i/runtime_image.html"><strong aria-hidden="true">1.5.</strong> Runtime Image</a></li><li><a href="../s2i/user_guide.html"><strong aria-hidden="true">1.6.</strong> User Guide</a></li></ol></li><li><a href="../builders.html"><strong aria-hidden="true">2.</strong> Builders</a></li><li><ol class="section"><li><a href="../builders/php.html"><strong aria-hidden="true">2.1.</strong> php</a></li><li><a href="../builders/nodejs.html"><strong aria-hidden="true">2.2.</strong> nodejs</a></li><li><a href="../builders/java.html"><strong aria-hidden="true">2.3.</strong> java</a></li><li><a href="../builders/go.html"><strong aria-hidden="true">2.4.</strong> go</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Zcloud Source to Image</h1>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#s2i-builder-image-requirements" id="s2i-builder-image-requirements">s2i builder image requirements</a></h1>
<p>The main advantage of using s2i for building reproducible docker images is ease
of use for developers. To meet that criteria you, as a builder image author,
should be aware of the two basic requirements for the best possible s2i
performance. These are:</p>
<ul>
<li><a href="#required-image-contents">required image contents</a></li>
<li><a href="#s2i-scripts">s2i scripts</a></li>
</ul>
<h1><a class="header" href="#required-image-contents" id="required-image-contents">Required image contents</a></h1>
<p>The build process consists of three fundamental elements which are combined into the
final docker image. These are: source code, s2i scripts, and the builder image. During the
build process s2i must place sources and scripts inside that builder image. To do
so s2i creates a tar file containing the two and then streams that file into the
builder image. Before executing the <code>assemble</code> script, s2i untars that file and places
its contents into the destination specified with either the <code>--destination</code> flag or the value of
the <code>io.openshift.s2i.destination</code> label set in the builder image (the default destination is <code>/tmp</code>).
If your image does not have either <code>tar</code> or <code>/bin/sh</code> the s2i build will perform an additional
docker build to place the source code and scripts into an appropriate image and then run
the normal s2i build.</p>
<p>The following diagram illustrates the build workflow:</p>
<p><img src="./sti-flow.png" alt="s2i workflow" title="s2i workflow" /></p>
<p>* Run build's responsibility is to untar the sources, scripts and (optionally) artifacts
and invoke the <code>assemble</code> script. If this is the second run after any previous runs with
<code>tar</code>/<code>/bin/sh</code> errors, it will only run the <code>assemble</code> script, since both the source and
scripts are already present.</p>
<h1><a class="header" href="#s2i-scripts" id="s2i-scripts">s2i scripts</a></h1>
<p><code>s2i</code> expects you (the builder image author) to supply the following scripts:</p>
<ul>
<li>required:
<ul>
<li><a href="#assemble">assemble</a></li>
<li><a href="#run">run</a></li>
</ul>
</li>
<li>optional:
<ul>
<li><a href="#save-artifacts">save-artifacts</a></li>
<li><a href="#usage">usage</a></li>
<li><a href="#testrun">test/run</a></li>
</ul>
</li>
</ul>
<p>All of the scripts can be written in any programming language, as long as the scripts
are executable inside the builder image. The build searches the following locations for
these scripts in the following order:</p>
<ol>
<li>A script found at the <code>--scripts-url</code> URL</li>
<li>A script found in the application source <code>.s2i/bin</code> directory</li>
<li>A script found at the default image URL (<code>io.openshift.s2i.scripts-url</code> label)</li>
</ol>
<p>Both the <code>io.openshift.s2i.scripts-url</code> label specified in the image and <code>--scripts-url</code> flag
can be supplied in any of the following forms to indicate where the scripts are located:</p>
<ul>
<li><code>image://path_to_scripts_dir</code> - absolute path inside the image</li>
<li><code>file://path_to_scripts_dir</code> - relative or absolute path on the host machine</li>
<li><code>http(s)://path_to_scripts_dir</code> - URL to a directory</li>
</ul>
<p><strong>NOTE</strong>: In the case where the scripts are already placed inside the image (ie when
using <code>--scripts-url</code> flag or the <code>io.openshift.s2i.scripts-url</code> with the format
<code>image:///path/in/image</code>), then the <code>--destination</code> flag or the <code>io.openshift.s2i.destination</code>
label applies only to sources and artifacts.</p>
<h2><a class="header" href="#assemble" id="assemble">assemble</a></h2>
<p>The <code>assemble</code> script is responsible for building the application artifacts from source
and placing them into the appropriate directories inside the image. The workflow for the
<code>assemble</code> script is:</p>
<ol>
<li>Restore build artifacts (in case you want to support incremental builds (if using this,
make sure you define <a href="#save-artifacts">save-artifacts</a>) as well.</li>
<li>Place the application source code in the appropriate location.</li>
<li>Build any application artifacts.</li>
<li>Install the artifacts into locations appropriate for running.</li>
</ol>
<p>In the case you need to assemble the Image using a different user than the runtime user defined 
in <code>USER</code> directive of Dockerfile, you can achive this by the following ways:</p>
<ol>
<li>use the <code>--assemble-user</code> in cmd line</li>
<li>use the label <code>io.openshift.s2i.assemble-user</code></li>
</ol>
<h4><a class="header" href="#example-assemble-script" id="example-assemble-script">Example <code>assemble</code> script:</a></h4>
<p><strong>NOTE</strong>: All the examples are written in <a href="http://www.gnu.org/software/bash/">Bash</a>
and it is assumed that the tar contents unpack into the <code>/tmp</code> directory.</p>
<pre><code>#!/bin/bash

# restore build artifacts
if [ &quot;$(ls /tmp/artifacts/ 2&gt;/dev/null)&quot; ]; then
    mv /tmp/artifacts/* $HOME/.
fi

# move the application source
mv /tmp/s2i/src $HOME/src

# build application artifacts
pushd ${HOME}
make all

# install the artifacts
make install
popd
</code></pre>
<h2><a class="header" href="#run" id="run">run</a></h2>
<p>The <code>run</code> script is responsible for executing your application.</p>
<h4><a class="header" href="#example-run-script" id="example-run-script">Example <code>run</code> script:</a></h4>
<pre><code>#!/bin/bash

# run the application
/opt/application/run.sh
</code></pre>
<h2><a class="header" href="#save-artifacts" id="save-artifacts">save-artifacts</a></h2>
<p>The <code>save-artifacts</code> script is responsible for gathering all the dependencies into a tar file and streaming it to the standard output (eg. for Ruby - gems installed by Bundler, for Java - <code>.m2</code> contents, etc.).  The existence of this can speed up the following build processes.  Note: it is critical that the <code>save-artifacts</code> script output only include the tar stream output and nothing else.  This is handled by redirecting output to /dev/null in the sample script below.</p>
<h4><a class="header" href="#example-save-artifacts-script" id="example-save-artifacts-script">Example <code>save-artifacts</code> script:</a></h4>
<pre><code>#!/bin/bash

# Besides the tar command, all other output to standard out must 
# be surpressed.  Otherwise, the tar stream will be corrupted.
pushd ${HOME} &gt;/dev/null
if [ -d deps ]; then
    # all deps contents to tar stream
    tar cf - deps
fi
popd &gt;/dev/null

</code></pre>
<h2><a class="header" href="#usage" id="usage">usage</a></h2>
<p>The <code>usage</code> script is for you (as the builder image author) to inform the user
how to use your image.</p>
<h4><a class="header" href="#example-usage-script" id="example-usage-script">Example <code>usage</code> script:</a></h4>
<pre><code>#!/bin/bash

# inform the user how to use the image
cat &lt;&lt;EOF
This is a S2I sample builder image, to use it, install
https://github.com/openshift/source-to-image
EOF
</code></pre>
<h2><a class="header" href="#testrun" id="testrun">test/run</a></h2>
<p>The <code>test/run</code> script is for you (as the builder image author) to create a simple
process to check whether the image is working correctly. The workflow of that process
should be the following:</p>
<ol>
<li>Build the image.</li>
<li>Run the image to verify the <code>usage</code> script.</li>
<li>Run the <code>s2i build</code> to verify <code>assemble</code> script.</li>
<li>(Optional) Run the <code>s2i build</code> once more to verify <code>save-artifacts</code> script and
<code>assemble</code>'s restore artifacts functionality.</li>
<li>Run the image to verify the test application is working.</li>
</ol>
<p><strong>NOTE</strong> The suggested place to put your test application built by your
<code>test/run</code> script is <code>test/test-app</code> in your image repository, see
<a href="https://github.com/openshift/source-to-image/blob/master/docs/cli.md#s2i-create">s2i create</a>.</p>
<h1><a class="header" href="#additional-steps" id="additional-steps">Additional steps</a></h1>
<h2><a class="header" href="#openshift-support" id="openshift-support">OpenShift support</a></h2>
<p>If you are intending to use this image with <a href="https://github.com/openshift/origin">OpenShift</a>, review and follow the OpenShift <a href="https://docs.okd.io/latest/creating_images/guidelines.html">image creation guidelines</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../s2i.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../s2i/cli.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="../s2i.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="../s2i/cli.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        
        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:8089");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload(true); // force reload from server (not from cache)
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        

        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
